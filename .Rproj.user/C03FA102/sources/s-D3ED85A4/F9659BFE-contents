#### Code for correlation Bayes factors and posteriors with informed priors ####

# Based on Ly, Maarsman & Wagenmakers (2018). doi:10.1111/stan.12111

# Reduced likelihood

#' @import hypergeo

A_nr <- function(N, R, Rho, Gamma, Delta){
  A <- (N-Gamma-1)/2
  B <- (N-Delta-1)/2
  Z <- R^2*Rho^2
  (1-Rho^2)^((N-Gamma-Delta-1)/2)*hypergeo::hypergeo(A, B, 0.5, Z)
}

W_n <- function(N, Gamma, Delta){
  term1 <- logOfGamma::gammaln((N-Gamma)/2) + logOfGamma::gammaln((N-Delta)/2)
  term2 <- logOfGamma::gammaln((N-Gamma-1)/2) + logOfGamma::gammaln((N-Delta-1)/2)
  exp(term1-term2)
}

B_nr <- function(N, R, Rho, Gamma, Delta){
  term1 <- 2*R*Rho*(1-Rho^2)^((N-Gamma-Delta-1)/2)
  A <- (N-Gamma)/2
  B <- (N-Delta)/2
  Z <- R^2*Rho^2
  res <- term1 * (W_n(N, Gamma, Delta)) * hypergeo::hypergeo(A, B, 1.5, Z)
  res[term1 == 0] <- 0
  return(res)
}

L_red <- function(N, R, Rho, Gamma, Delta){
  A_nr(N, R, Rho, Gamma, Delta) + B_nr(N, R, Rho, Gamma, Delta)
}

# Unstandardized posterior

cor_posterior_US <- function(Rho, N, R, alpha_prior, beta_prior){
  res <- L_red(N, R, Rho, Gamma = 0, Delta = 0) * stats::dbeta(Rho, alpha_prior, beta_prior)
  return(Re(res))
}

# Marginal likelihood

cor_ML <- function(N, R, alpha_prior, beta_prior){
  stats::integrate(function(x) cor_posterior_US(x, N, R, alpha_prior, beta_prior),
                   lower = 0, upper = 1, rel.tol = 1e-15)$value
  
}

#' Standardized posterior for Pearson correlation with informed prior
#' @param Rho Correlation parameter
#' @param N Sample size
#' @param R Pearson correlation coefficient in the sample
#' @param alpha_prior Alpha parameter in the beta prior on r
#' @param beta_prior Beta parameter in the beta prior on r
#' @export

cor_posterior <- function(Rho, N, R, alpha_prior, beta_prior){
  enum <- cor_posterior_US(Rho, N, R, alpha_prior, beta_prior)
  denom <- cor_ML(N, R, alpha_prior, beta_prior)
  enum/denom
}

#' Bayes factor for Pearson correlation with informed prior
#' @param N Sample size
#' @param R Pearson correlation coefficient in the sample
#' @param alpha_prior Alpha parameter in the beta prior on r
#' @param beta_prior Beta parameter in the beta prior on r
#' @importFrom stats integrate dbeta
#' @export

cor_BF10 <- function(N, R, alpha_prior, beta_prior){
  L0 <- Re(L_red(N, R, Rho=0, Gamma=0, Delta=0))
  L1 <- cor_ML(N, R, alpha_prior, beta_prior)
  L1/L0
}
